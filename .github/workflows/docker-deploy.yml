name: Build and Deploy to EC2

on:
  push:
    branches:
      - main
      - master

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME: mira-ai
  CONTAINER_NAME: mira-ai-app
  APP_PORT: 3001

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      id: build-push
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NPM_CONFIG_FETCH_TIMEOUT=600000
          NPM_CONFIG_FETCH_RETRY_MAXTIMEOUT=120000
          NPM_CONFIG_FETCH_RETRY_MINTIMEOUT=20000

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
        CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
        APP_PORT: ${{ env.APP_PORT }}
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: DOCKER_USERNAME,IMAGE_NAME,CONTAINER_NAME,APP_PORT
        script: |
          # Login to Docker Hub
          echo "Logging in to Docker Hub..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u $DOCKER_USERNAME --password-stdin
          
          # Pull the latest image
          echo "Pulling latest image..."
          docker pull $DOCKER_USERNAME/$IMAGE_NAME:latest
          
          # Stop and remove old container gracefully
          echo "Stopping old container..."
          if docker ps -q -f name=$CONTAINER_NAME | grep -q .; then
            docker stop -t 10 $CONTAINER_NAME
          fi
          
          # Remove container by name (running, stopped, or created)
          if docker ps -aq -f name=$CONTAINER_NAME | grep -q .; then
            echo "Removing existing container: $CONTAINER_NAME"
            docker rm -f $CONTAINER_NAME
          fi
          
          # Verify port is free, force cleanup if needed
          echo "Verifying port availability..."
          if docker ps -q --filter "publish=$APP_PORT" | grep -q .; then
            echo "Warning: Found container using port $APP_PORT, forcing removal..."
            docker ps -q --filter "publish=$APP_PORT" | xargs docker rm -f
          fi
          
          # Brief pause for OS to release resources
          sleep 2
          
          # Run new container
          echo "Starting new container..."
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            -p $APP_PORT:3001 \
            -v /home/ubuntu/mira-ai/data:/app/data \
            -e NODE_ENV=production \
            $DOCKER_USERNAME/$IMAGE_NAME:latest
          
          # Clean up old images
          echo "Cleaning up old images..."
          docker image prune -af --filter "label=org.opencontainers.image.title=$IMAGE_NAME"
          
          # Show running containers
          echo "Deployment complete! Running containers:"
          docker ps --filter "name=$CONTAINER_NAME"
          
          # Show logs
          echo "Container logs:"
          docker logs --tail 50 $CONTAINER_NAME